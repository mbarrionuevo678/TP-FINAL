name: CI/CD Pipeline 🚀

on:
  workflow_dispatch: # Para ejecución manual

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code 📥
        uses: actions/checkout@v2

      - name: Configure AWS credentials 🔐
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Install dependencies 🛠️
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl --silent --location "https://github.com/weaveworks/eksctl/releases/download/v0.118.0/eksctl_Linux_amd64.tar.gz" --output eksctl.tar.gz
          tar xzvf eksctl.tar.gz
          sudo mv eksctl /usr/local/bin
          rm eksctl.tar.gz

      - name: Create or Update Network 🌐
        run: |
          chmod +x scripts/create_network.sh
          ./scripts/create_network.sh

      - name: Create or Update EKS Cluster 🌐
        run: |
          chmod +x scripts/create_eks.sh
          ./scripts/create_eks.sh

      - name: Configure kubectl 🛠️
        run: |
          chmod +x scripts/configure_kubectl.sh
          ./scripts/configure_kubectl.sh

      - name: Install EBS CSI Driver 💾
        run: |
          chmod +x scripts/install_ebs_csi.sh
          ./scripts/install_ebs_csi.sh

      - name: Configure EBS 🛠️
        run: |
          chmod +x scripts/configure_ebs.sh
          ./scripts/configure_ebs.sh

      - name: Deploy NGINX 📦
        run: |
          chmod +x scripts/deploy_nginx.sh
          ./scripts/deploy_nginx.sh

      - name: Deploy Web App 🌐
        run: |
          chmod +x scripts/deploy_apps.sh
          ./scripts/deploy_apps.sh

      - name: Deploy Prometheus and Grafana 📊
        run: |
          chmod +x scripts/prometheus-grafana-deployment.sh
          ./scripts/prometheus-grafana-deployment.sh
