name: CI/CD Pipeline 🚀

on:
  workflow_dispatch: # Para ejecución manual

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code 📥
        uses: actions/checkout@v2

      - name: Configure AWS credentials 🔐
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Install eksctl 🛠️
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl --silent --location "https://github.com/weaveworks/eksctl/releases/download/v0.118.0/eksctl_Linux_amd64.tar.gz" --output eksctl.tar.gz
          tar xzvf eksctl.tar.gz
          sudo mv eksctl /usr/local/bin
          rm eksctl.tar.gz

      - name: Create or Update EKS Cluster 🌐
        run: |
          chmod +x scripts/configure_ebs.sh scripts/create_ec2.sh scripts/create_eks.sh scripts/deploy_monitoring.sh scripts/deploy_nginx.sh scripts/deploy_project.sh scripts/install_ebs_csi.sh scripts/deploy_apps.sh
          if ! eksctl get cluster --name=eks-mundos-e --region=us-east-1; then
            ./scripts/create_eks.sh
          else
            echo "Cluster eks-mundos-e already exists."
          fi

      - name: Create or Update EC2 Instance 💻
        run: |
          ./scripts/create_ec2.sh

      - name: Deploy NGINX 📦
        run: |
          ./scripts/deploy_nginx.sh

      - name: Install EBS CSI Driver 💾
        run: |
          ./scripts/install_ebs_csi.sh

      - name: Configure EBS 🛠️
        run: |
          ./scripts/configure_ebs.sh

      - name: Deploy Web App 🌐
        run: |
          ./scripts/deploy_apps.sh

      - name: Deploy Prometheus and Grafana 📊
        run: |
          ./scripts/prometheus-grafana-deployment.sh
