name: ğŸš€ Deploy to AWS

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ›ï¸ Checkout repository
      uses: actions/checkout@v2

    - name: ğŸŒ Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 1.1.0

    - name: ğŸ”‘ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: ğŸ—ï¸ Terraform Init
      run: terraform init

    - name: ğŸšœ Terraform Apply
      run: terraform apply -auto-approve
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: ğŸ“¦ Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    - name: ğŸ“¥ Add Helm repositories
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo update

    - name: ğŸ“ˆ Deploy Prometheus
      run: |
        kubectl apply -f manifests/persistent_volume_prometheus.yaml
        kubectl apply -f manifests/persistent_volume_claim_prometheus.yaml
        helm install prometheus prometheus-community/prometheus

    - name: ğŸ“Š Deploy Grafana
      run: |
        kubectl apply -f manifests/persistent_volume_grafana.yaml
        kubectl apply -f manifests/persistent_volume_claim_grafana.yaml
        helm install grafana grafana/grafana
        kubectl get svc --namespace default -w grafana

    - name: ğŸŒ Deploy Nginx
      run: |
        kubectl apply -f manifests/persistent_volume_nginx.yaml
        kubectl apply -f manifests/persistent_volume_claim_nginx.yaml
        kubectl apply -f manifests/nginx-deployment.yaml
        kubectl apply -f manifests/nginx-service.yaml

    - name: ğŸš› Install EBS CSI Driver
      run: |
        kubectl apply -k "github.com/kubernetes-sigs/aws-ebs-csi-driver/deploy/kubernetes/overlays/stable/ecr/?ref=release-1.3"
